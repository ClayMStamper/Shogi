using System.Collections;
using System.Collections.Generic;
using UnityEngine;

[RequireComponent(typeof(AudioSource))]
public class MusicManager : MonoBehaviour {

	#region Singleton
	private static MusicManager instance;

	void Awake(){
		if (instance == null) {
			instance = this;
		} else {
			//    Debug.LogError("More than one " + transform.name + " in the scene");
			Destroy (gameObject);
		}
		DontDestroyOnLoad (gameObject);
	}

	public static MusicManager GetInstance(){
		return instance;
	}

	#endregion

	LevelManager levelManager;

	AudioSource audioSource;
	[SerializeField]
	[Tooltip("Audio clips for each scene (in build index order)")]
	AudioClip[] clips;

	private int sceneIndex = 0;

	[SerializeField]
	float fadeSpeed;

	void Start(){

		levelManager = LevelManager.GetInstance ();
		levelManager.onLevelWasLoadedCallback += OnLevelLoaded;
		audioSource = GetComponent <AudioSource> ();

		audioSource.volume = Settings.maxVolume;

	}

	void OnLevelLoaded(){

		sceneIndex = levelManager.GetCurrentLevelIndex();

		if (audioSource.clip != clips [sceneIndex]) {
			
			StartCoroutine(fadeOutClip());

		}

	}

	IEnumerator fadeOutClip(){

		//Debug.Log ("Clip fading out");

		while (audioSource.volume > 0f){

			//Debug.Log ("Volume: " + audioSource.volume);

			audioSource.volume -= Time.deltaTime * fadeSpeed;

			yield return null;

		}

		StartCoroutine (FadeInClip ());
		yield return null;

	}

	IEnumerator FadeInClip(){

		//Debug.Log ("Clip fading in");

		int sceneIndex = levelManager.GetCurrentLevelIndex();
		audioSource.clip = clips [sceneIndex];
		audioSource.Play ();

		while (audioSource.volume < Settings.maxVolume){ 

			//Debug.Log ("Volume: " + audioSource.volume);

			audioSource.volume += Time.deltaTime * fadeSpeed;

			yield return null;

		}
			
		yield return null;

	}

	public void UpdateVoluime(){
		audioSource.volume = Settings.maxVolume;
	}

}
